(()=>{var t={n:i=>{var n=i&&i.__esModule?()=>i.default:()=>i;return t.d(n,{a:n}),n},d:(i,n)=>{for(var s in n)t.o(n,s)&&!t.o(i,s)&&Object.defineProperty(i,s,{enumerable:!0,get:n[s]})},o:(t,i)=>Object.prototype.hasOwnProperty.call(t,i),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},i={};(()=>{"use strict";t.r(i);const n=flarum.core.compat["common/app"];var s=t.n(n);const e=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/components/DiscussionComposer"];var a=t.n(o);const r=flarum.core.compat["forum/utils/DiscussionControls"];var u=t.n(r);const l=flarum.core.compat["forum/app"];var c=t.n(l);const p=flarum.core.compat["forum/components/SettingsPage"];var g=t.n(p);const f=flarum.core.compat["common/components/FieldSet"];var h=t.n(f);const d=flarum.core.compat["common/utils/ItemList"];var v=t.n(d);const P=flarum.core.compat["common/components/Switch"];var y=t.n(P);const b=flarum.core.compat["common/utils/Stream"];var D=t.n(b);function L(){return L=Object.assign?Object.assign.bind():function(t){for(var i=1;i<arguments.length;i++){var n=arguments[i];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s])}return t},L.apply(this,arguments)}const C=flarum.core.compat["forum/states/DiscussionListState"];var k=t.n(C);const O=flarum.core.compat["forum/components/DiscussionList"];var x=t.n(O);const T=flarum.core.compat["forum/components/DiscussionListItem"];var I=t.n(T);const w=flarum.core.compat["common/utils/classList"];var N=t.n(w);function R(t,i){return R=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,i){return t.__proto__=i,t},R(t,i)}const M=flarum.core.compat["common/Component"];var A=t.n(M);const S=flarum.core.compat["common/components/Button"];var B=t.n(S),_=function(t){var i,n;function s(){for(var i,n=arguments.length,s=new Array(n),e=0;e<n;e++)s[e]=arguments[e];return(i=t.call.apply(t,[this].concat(s))||this).attrs=void 0,i}n=t,(i=s).prototype=Object.create(n.prototype),i.prototype.constructor=i,R(i,n);var e=s.prototype;return e.view=function(t){var i=this.attrs.state;return m("div",{className:"Pagination"},m("ul",{class:"IndexPage-toolbar-view"},m("li",null,this.buttonFirst()),m("li",null,this.buttonBack()),i.ctrl.pageList().map((function(t){return m("li",null,m(B(),{title:t,className:i.page().number==t?"Button Button--primary Button--active":"Button",onclick:function(){i.ctrl.toPage(t)}},t))})),m("li",null,this.buttonNext()),m("li",null,this.buttonLast()),m("li",null,this.inputJump()),m("li",null,this.buttonJump())))},e.buttonFirst=function(){var t=this.attrs.state;return B().component({title:"First",icon:"fa fa-angle-double-left fas fa-angles-left",className:"Button Button--icon",onclick:function(){t.ctrl.toPage(1)},disabled:1==t.page().number})},e.buttonBack=function(){var t=this.attrs.state;return B().component({title:"Back",icon:"fa fa-angle-left fas",className:"Button Button--icon",onclick:function(){var i=t.page().number;t.ctrl.toPage(parseInt(i)-1)},disabled:1==t.page().number})},e.buttonNext=function(){var t=this.attrs.state;return B().component({title:"Next",icon:"fa fa-angle-right fas",className:"Button Button--icon",onclick:function(){var i=t.page().number;t.ctrl.toPage(parseInt(i)+1)},disabled:t.page().number==t.totalPages()})},e.buttonLast=function(){var t=this.attrs.state;return B().component({title:"Last",icon:"fa fa-angle-double-right fas fa-angles-right",className:"Button Button--icon",onclick:function(){var i=parseInt(t.totalPages());t.ctrl.toPage(i)},disabled:t.page().number==t.totalPages()})},e.JumpFunc=function(){var t,i=this.attrs.state,n=parseInt(null==(t=document.getElementById("pagination-inputJump"))?void 0:t.value);Number.isFinite(n)&&Number.isSafeInteger(n)&&n!=i.page().number&&1<=n&&n<=i.totalPages()&&i.ctrl.toPage(n)},e.inputJump=function(){var t=this,i=this.attrs.state;return m("input.FromControl",{id:"pagination-inputJump",placeholder:void 0===i.page().number?"":""+i.page().number,onkeydown:function(i){i.redraw=!1,13==i.keyCode&&(i.redraw=!0,t.JumpFunc())}})},e.buttonJump=function(){return B().component({title:"Jump",icon:"fa fa-paper-plane fas",className:"Button Button--icon",onclick:this.JumpFunc.bind(this)})},s}(A());function j(){(0,e.override)(x().prototype,"view",(function(t){var i,n,e=null==(i=this.attrs)?void 0:i.state,o=t();if(o.attrs=o.attrs||{},o.attrs.className=N()("DiscussionList",{"DiscussionList--searchResults":null==e||null==e.isSearchResults?void 0:e.isSearchResults()},o.attrs.className),null==e||!e.usePaginationMode||null!=e.isLoading&&e.isLoading()||null!=e.isEmpty&&e.isEmpty())return o;var a="walsgit-discussion-cards"in flarum.extensions,r=(null==(n=e.options)?void 0:n.perPage)||0,u=e.page||1,l=(null==e.getParams?void 0:e.getParams())||{},c=e.getPages?e.getPages(!0):[],p=[];if(Array.isArray(c)&&c.length){var g=c.find((function(t){var i;return(null==t?void 0:t.number)===(null==(i=e.location)?void 0:i.page)}))||c[0];g&&Array.isArray(g.items)&&(p=g.items)}var f=p.length?p.map((function(t,i){return m("li",{key:t.id(),"data-id":t.id(),role:"article","aria-setsize":-1,"aria-posinset":u*r+i},m(I(),{discussion:t,params:l}))})):null,h=function(t){return Array.isArray(t)?t:t&&Array.isArray(t.children)?t.children:null},d=[];if(function t(i,n,s){if(i)if(Array.isArray(i))for(var e=0;e<i.length;e++)t(i[e],i,e);else if("string"!=typeof i&&"number"!=typeof i){(r=i)&&"ul"===r.tag&&(u=r.attrs,String(u&&(u.className||u.class)||"")).includes("DiscussionList-discussions")&&d.push({node:i,parent:n,index:s});var o=h(i);if(o)for(var a=0;a<o.length;a++)t(o[a],i,a)}var r,u}(o,null,null),a)return O(k(),o,d.length?d[0]:null,e),o;if(d.length>0){var v=d.find((function(t){var i=h(t.node);return i&&i.some((function(t){return t&&"li"===t.tag}))}))||d.find((function(t){var i;return(null==(i=t.node)?void 0:i.attrs)&&"aria-busy"in t.node.attrs}))||d[0];if(f){var P=h(v.node);P?P.splice.apply(P,[0,P.length].concat(f)):v.node.children=f}for(var y=d.length-1;y>=0;y--){var b,D=d[y];if(D!==v){var L=h((Array.isArray(D.parent),D.parent));if(L){var C=null!=(b=D.index)?b:L.indexOf(D.node);C>=0&&L[C]===D.node&&((h(D.node)||[]).some((function(t){return t&&"li"===t.tag}))||L.splice(C,1))}}}return O(k(),o,v,e),o}return O(k(),o,null,e),o;function k(){return s().forum.attribute("foskym-pagination.paginationPosition")}function O(t,i,n,s){var e="above"===t||"both"===t,o="under"===t||"both"===t;if(e||o){var a=_.component({state:s});if(n&&n.parent){var r,u=n.parent,l=h((Array.isArray(u),u));if(!l)return;var c=null!=(r=n.index)?r:l.indexOf(n.node);c<0&&(c=0),e&&l.splice(c,0,a),o&&l.splice(c+(e?2:1),0,a)}else{var p=h(i);if(!p)return;e&&p.unshift(a),o&&p.push(a)}}}}))}s().initializers.add("foskym/flarum-pagination",(function(){(0,e.extend)(g().prototype,"oninit",(function(){var t=this.user.preferences();this.userCustom=D()(t["foskym-pagination.userCustom"]),this.userPaginationOnLoading=D()(t["foskym-pagination.userPaginationOnLoading"])})),(0,e.extend)(g().prototype,"settingsItems",(function(t){Boolean(c().forum.attribute("foskym-pagination.canUserPref"))&&t.add("pagination_settings",h().component({label:c().translator.trans("foskym-pagination.forum.user.settings.head"),className:"SettingsPage-pagination"},this.Pagination_UserPrefItems().toArray()))})),g().prototype.Pagination_UserPrefItems=function(){var t=this,i=new(v());return i.add("foskym-pagination.userCustom",y().component({state:this.user.preferences()["foskym-pagination.userCustom"],onchange:function(i){t.UserCustom_Loading=!0,t.user.savePreferences({"foskym-pagination.userCustom":i}).then((function(){t.UserCustom_Loading=!1,m.redraw()}))},loading:this.UserCustom_Loading},c().translator.trans("foskym-pagination.forum.user.settings.userCustom"))),this.user.preferences()["foskym-pagination.userCustom"]&&i.add("foskym-pagination.userPaginationOnLoading",y().component({state:this.user.preferences()["foskym-pagination.userPaginationOnLoading"],onchange:function(i){t.userPaginationOnLoading_Loading=!0,t.user.savePreferences({"foskym-pagination.userPaginationOnLoading":i}).then((function(){t.userPaginationOnLoading_Loading=!1,m.redraw()}))},loading:this.userPaginationOnLoading_Loading},c().translator.trans("foskym-pagination.forum.user.settings.userPaginationOnLoading"))),i},k().prototype.initOptions=function(){this.options={cacheDiscussions:s().forum.attribute("foskym-pagination.cacheDiscussions"),perPage:s().forum.attribute("foskym-pagination.perPage"),perLoadMore:s().forum.attribute("foskym-pagination.perLoadMore"),perIndexInit:s().forum.attribute("foskym-pagination.perIndexInit"),leftEdges:4,rightEdges:5},this.usePaginationMode=function(){if(null===c().session.user)return c().forum.attribute("foskym-pagination.paginationOnLoading");var t=c().session.user.preferences();return c().forum.attribute("foskym-pagination.canUserPref")&&t["foskym-pagination.userCustom"]?!!t["foskym-pagination.userPaginationOnLoading"]:c().forum.attribute("foskym-pagination.paginationOnLoading")}(),this.lastTotalDiscussionCount=0,this.lastTotalPages=0,this.lastDiscussions=[],this.lastLoadedPage={},this.lastRequestParams={},this.optionInitialized=!0},(0,e.override)(k().prototype,"refreshParams",(function(t,i,n){var s=this;void 0===n&&(n=1);var e=t(i,n);return this.usePaginationMode&&"function"==typeof this.refresh?Promise.resolve(e).then((function(){return s.refresh(1)})):e})),(0,e.override)(k().prototype,"refresh",(function(t,i){var n=this;return void 0===i&&(i=1),this.optionInitialized||this.initOptions(),this.usePaginationMode?(this.initialLoading=!0,this.loadingPrev=!1,this.loadingNext=!1,this.isRefreshing=!0,this.clear(),this.location={page:i},this.loadPage(i).then((function(t){n.pages=[],n.parseResults(n.location.page,t)})).finally((function(){n.initialLoading=!1,n.isRefreshing=!1}))):(this.pageSize=this.options.perLoadMore,t(i))})),(0,e.override)(k().prototype,"loadPage",(function(t,i){void 0===i&&(i=1);var n=this.requestParams();this.optionInitialized||this.initOptions(),this.lastRequestParams.include||(this.lastRequestParams=n);var e=s().preloadedApiDocument();if(e)return this.initialLoading=!1,this.isRefreshing=!1,this.totalDiscussionCount=D()(e.payload.jsonapi.totalResultsCount),this.lastTotalDiscussionCount=this.totalDiscussionCount(),Promise.resolve(e);if(!this.isRefreshing&&this.options.cacheDiscussions){var o=JSON.stringify(n.include)!==JSON.stringify(this.lastRequestParams.include),a=JSON.stringify(n.filter)!==JSON.stringify(this.lastRequestParams.filter),r=n.sort!==this.lastRequestParams.sort;if(!(o||a||r)&&this.lastLoadedPage[i]){var u=this.options.perPage*(i-1),l=this.options.perPage*i,c=this.lastDiscussions.slice(u,l);return c.payload={jsonapi:{totalResultsCount:this.totalDiscussionCount()}},this.initialLoading=!0,m.redraw(),new Promise((function(t){return setTimeout((function(){return t(c)}),50)}))}}var p,g,f=Array.isArray(n.include)?n.include.join(","):n.include;this.usePaginationMode?(p=this.options.perPage*(i-1),g=this.options.perPage):g=0==(p=this.options.perIndexInit*Math.min(i-1,1)+this.options.perLoadMore*Math.max(i-2,0))?this.options.perIndexInit:this.options.perLoadMore;var h=L({},n,{page:L({},n.page,{offset:p,limit:g}),include:f});return s().store.find(this.type,h)})),(0,e.override)(k().prototype,"getAllItems",(function(t){return"walsgit-discussion-cards"in flarum.extensions?this.extraDiscussions.concat(this.getPages(!0).map((function(t){return t.items})).flat()):t()})),(0,e.override)(k().prototype,"getPages",(function(t,i){var n=this;void 0===i&&(i=!1);var s=t();return"walsgit-discussion-cards"in flarum.extensions?i?s:[s.find((function(t){return t.number===n.location.page}))]:s})),(0,e.override)(k().prototype,"parseResults",(function(t,i,n){var s;if(!this.usePaginationMode)return t(i,n);var e=Number(i),o=(null==(s=n.payload)?void 0:s.links)||{},a={number:e,items:n,hasNext:!(null==o||!o.next),hasPrev:!(null==o||!o.prev)};if(this.hasPage=function(t){var i=this.getPages(!0);return 0!==i.length&&i.some((function(i){return i.number===t}))},this.hasPage(e)||this.pages.push(a),this.pages=this.pages.sort((function(t,i){return t.number-i.number})),this.location={page:e},this.totalDiscussionCount=D()(n.payload.jsonapi.totalResultsCount),this.options.cacheDiscussions)if(this.lastTotalDiscussionCount!==this.totalDiscussionCount()&&0!==this.lastTotalDiscussionCount||0===this.lastTotalDiscussionCount||this.isRefreshing)this.lastTotalDiscussionCount=this.totalDiscussionCount(),this.lastDiscussions=new Array(this.lastTotalDiscussionCount),this.lastLoadedPage={};else{var r;this.lastLoadedPage[e]=a;var u=this.options.perPage*(e-1),l=this.options.perPage*e;(r=this.lastDiscussions).splice.apply(r,[u,l-u].concat(n))}this.getTotalPages=function(){return Math.ceil(this.totalDiscussionCount()/this.options.perPage)},this.page=D()(a),this.perPage=D()(this.options.perPage),this.totalPages=D()(this.getTotalPages()),this.ctrl={scrollToTop:function(){var t=document.querySelector("#content > .IndexPage > .container"),i=document.querySelector("#header"),n=0;if(i&&(n=i.clientHeight),t){var s=t.getBoundingClientRect().top+window.scrollY-n;setTimeout((function(){return window.scrollTo({top:s,behavior:"smooth"})}),50)}}.bind(this),prevPage:function(){var t=this,i=this.page().number-1;i<1||(this.page(i),this.loadingPrev=!0,this.loadPage(i).then((function(n){t.parseResults(i,n),t.loadingPrev=!1,t.ctrl.scrollToTop()})))}.bind(this),nextPage:function(){var t=this,i=this.page().number+1;i>this.totalPages()?i=this.totalPages():(this.page(i),this.loadingNext=!0,this.loadPage(i).then((function(n){t.parseResults(i,n),t.loadingNext=!1,t.ctrl.scrollToTop()})))}.bind(this),toPage:function(t){var i=this,n=Number(t);this.page().number===n||n<1||n>this.totalPages()||(this.page(n),this.initialLoading=!0,this.loadPage(n).then((function(t){i.parseResults(n,t),i.initialLoading=!1,i.ctrl.scrollToTop()})))}.bind(this),pageList:function(){for(var t=[],i=Math.max(parseInt(this.page().number)-this.options.leftEdges,1),n=Math.min(parseInt(this.page().number)+this.options.rightEdges,this.totalPages()),s=i;s<=n;s++)t.push(s);return t}.bind(this)},m.redraw()})),(0,e.override)(k().prototype,"addDiscussion",(function(t,i){var n=this;if(!this.usePaginationMode)return t(i);clearTimeout(this.__rtRefreshTimer),this.__rtRefreshTimer=setTimeout((function(){n.page=n.page||D()({number:1,items:[]}),n.location={page:1},n.refresh(1)}),50);var s=this.lastDiscussions.indexOf(i);-1!==s?(this.lastDiscussions.splice(s),this.lastDiscussions.unshift(i)):(this.lastDiscussions.unshift(i),this.lastTotalDiscussionCount++,this.totalDiscussionCount(this.lastTotalDiscussionCount)),m.redraw()})),(0,e.override)(k().prototype,"deleteDiscussion",(function(t,i){if(!this.usePaginationMode)return t(i);var n=this.lastDiscussions.indexOf(i);-1!==n&&(this.lastDiscussions.splice(n),this.lastTotalDiscussionCount--,this.totalDiscussionCount(this.lastTotalDiscussionCount)),m.redraw()})),(0,e.override)(k().prototype,"clear",(function(t){return this.usePaginationMode?(this.lastDiscussions=[],this.lastLoadedPage={},this.lastRequestParams={},this.lastTotalDiscussionCount=0,this.lastTotalPages=0,this.totalDiscussionCount=D()(0),t()):t()})),j(),(0,e.extend)(u(),"deleteAction",(function(){if(this.usePaginationMode&&s().discussions){var t=s().discussions.location.page;s().discussions.refresh(t)}})),(0,e.extend)(a().prototype,"onsubmit",(function(){this.usePaginationMode&&s().discussions&&s().discussions.refresh()}))}),-2)})(),module.exports=i})();
//# sourceMappingURL=forum.js.map