(()=>{var t={n:i=>{var s=i&&i.__esModule?()=>i.default:()=>i;return t.d(s,{a:s}),s},d:(i,s)=>{for(var n in s)t.o(s,n)&&!t.o(i,n)&&Object.defineProperty(i,n,{enumerable:!0,get:s[n]})},o:(t,i)=>Object.prototype.hasOwnProperty.call(t,i),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},i={};(()=>{"use strict";t.r(i);const s=flarum.core.compat["common/app"];var n=t.n(s);const e=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/components/DiscussionComposer"];var a=t.n(o);const r=flarum.core.compat["forum/utils/DiscussionControls"];var u=t.n(r);const l=flarum.core.compat["forum/app"];var c=t.n(l);const p=flarum.core.compat["forum/components/SettingsPage"];var h=t.n(p);const g=flarum.core.compat["common/components/FieldSet"];var f=t.n(g);const d=flarum.core.compat["common/utils/ItemList"];var v=t.n(d);const P=flarum.core.compat["common/components/Switch"];var y=t.n(P);const b=flarum.core.compat["common/utils/Stream"];var L=t.n(b);function D(){return D=Object.assign?Object.assign.bind():function(t){for(var i=1;i<arguments.length;i++){var s=arguments[i];for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=s[n])}return t},D.apply(this,arguments)}const C=flarum.core.compat["forum/states/DiscussionListState"];var O=t.n(C);function k(t,i){void 0===i&&(i=!0);try{var s=new URL(window.location.href);t<=1?s.searchParams.delete("page"):s.searchParams.set("page",String(t));var n=s.pathname+s.search+s.hash,e=window&&window.m||null;e&&e.route&&"function"==typeof e.route.set?e.route.set(n,void 0,{replace:!0}):(i?history.replaceState:history.pushState).call(history,null,"",n)}catch(t){}}const w=flarum.core.compat["forum/components/DiscussionList"];var x=t.n(w);const R=flarum.core.compat["forum/components/DiscussionListItem"];var T=t.n(R);const N=flarum.core.compat["common/utils/classList"];var S=t.n(N);function I(t,i){return I=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,i){return t.__proto__=i,t},I(t,i)}const M=flarum.core.compat["common/Component"];var A=t.n(M);const B=flarum.core.compat["common/components/Button"];var _=t.n(B),J=function(t){var i,s;function n(){for(var i,s=arguments.length,n=new Array(s),e=0;e<s;e++)n[e]=arguments[e];return(i=t.call.apply(t,[this].concat(n))||this).attrs=void 0,i}s=t,(i=n).prototype=Object.create(s.prototype),i.prototype.constructor=i,I(i,s);var e=n.prototype;return e.view=function(t){var i=this.attrs.state;return m("div",{className:"Pagination"},m("ul",{class:"IndexPage-toolbar-view"},m("li",null,this.buttonFirst()),m("li",null,this.buttonBack()),i.ctrl.pageList().map((function(t){return m("li",null,m(_(),{title:t,className:i.page().number==t?"Button Button--primary Button--active":"Button",onclick:function(){i.ctrl.toPage(t)}},t))})),m("li",null,this.buttonNext()),m("li",null,this.buttonLast()),m("li",null,this.inputJump()),m("li",null,this.buttonJump())))},e.buttonFirst=function(){var t=this.attrs.state;return _().component({title:"First",icon:"fa fa-angle-double-left fas fa-angles-left",className:"Button Button--icon",onclick:function(){t.ctrl.toPage(1)},disabled:1==t.page().number})},e.buttonBack=function(){var t=this.attrs.state;return _().component({title:"Back",icon:"fa fa-angle-left fas",className:"Button Button--icon",onclick:function(){var i=t.page().number;t.ctrl.toPage(parseInt(i)-1)},disabled:1==t.page().number})},e.buttonNext=function(){var t=this.attrs.state;return _().component({title:"Next",icon:"fa fa-angle-right fas",className:"Button Button--icon",onclick:function(){var i=t.page().number;t.ctrl.toPage(parseInt(i)+1)},disabled:t.page().number==t.totalPages()})},e.buttonLast=function(){var t=this.attrs.state;return _().component({title:"Last",icon:"fa fa-angle-double-right fas fa-angles-right",className:"Button Button--icon",onclick:function(){var i=parseInt(t.totalPages());t.ctrl.toPage(i)},disabled:t.page().number==t.totalPages()})},e.JumpFunc=function(){var t,i=this.attrs.state,s=parseInt(null==(t=document.getElementById("pagination-inputJump"))?void 0:t.value);Number.isFinite(s)&&Number.isSafeInteger(s)&&s!=i.page().number&&1<=s&&s<=i.totalPages()&&i.ctrl.toPage(s)},e.inputJump=function(){var t=this,i=this.attrs.state;return m("input.FromControl",{id:"pagination-inputJump",placeholder:void 0===i.page().number?"":""+i.page().number,onkeydown:function(i){i.redraw=!1,13==i.keyCode&&(i.redraw=!0,t.JumpFunc())}})},e.buttonJump=function(){return _().component({title:"Jump",icon:"fa fa-paper-plane fas",className:"Button Button--icon",onclick:this.JumpFunc.bind(this)})},n}(A());function j(){(0,e.override)(x().prototype,"view",(function(t){var i,s,e=null==(i=this.attrs)?void 0:i.state,o=t();if(o.attrs=o.attrs||{},o.attrs.className=S()("DiscussionList",{"DiscussionList--searchResults":null==e||null==e.isSearchResults?void 0:e.isSearchResults()},o.attrs.className),null==e||!e.usePaginationMode||null!=e.isLoading&&e.isLoading()||null!=e.isEmpty&&e.isEmpty())return o;var a="walsgit-discussion-cards"in flarum.extensions,r=(null==(s=e.options)?void 0:s.perPage)||0,u=e.page||1,l=(null==e.getParams?void 0:e.getParams())||{},c=e.getPages?e.getPages(!0):[],p=[];if(Array.isArray(c)&&c.length){var h=c.find((function(t){var i;return(null==t?void 0:t.number)===(null==(i=e.location)?void 0:i.page)}))||c[0];h&&Array.isArray(h.items)&&(p=h.items)}var g=p.length?p.map((function(t,i){return m("li",{key:t.id(),"data-id":t.id(),role:"article","aria-setsize":-1,"aria-posinset":u*r+i},m(T(),{discussion:t,params:l}))})):null,f=function(t){return Array.isArray(t)?t:t&&Array.isArray(t.children)?t.children:null},d=[];if(function t(i,s,n){if(i)if(Array.isArray(i))for(var e=0;e<i.length;e++)t(i[e],i,e);else if("string"!=typeof i&&"number"!=typeof i){(r=i)&&"ul"===r.tag&&(u=r.attrs,String(u&&(u.className||u.class)||"")).includes("DiscussionList-discussions")&&d.push({node:i,parent:s,index:n});var o=f(i);if(o)for(var a=0;a<o.length;a++)t(o[a],i,a)}var r,u}(o,null,null),a)return k(O(),o,d.length?d[0]:null,e),o;if(d.length>0){var v=d.find((function(t){var i=f(t.node);return i&&i.some((function(t){return t&&"li"===t.tag}))}))||d.find((function(t){var i;return(null==(i=t.node)?void 0:i.attrs)&&"aria-busy"in t.node.attrs}))||d[0];if(g){var P=f(v.node);P?P.splice.apply(P,[0,P.length].concat(g)):v.node.children=g}for(var y=d.length-1;y>=0;y--){var b,L=d[y];if(L!==v){var D=f((Array.isArray(L.parent),L.parent));if(D){var C=null!=(b=L.index)?b:D.indexOf(L.node);C>=0&&D[C]===L.node&&((f(L.node)||[]).some((function(t){return t&&"li"===t.tag}))||D.splice(C,1))}}}return k(O(),o,v,e),o}return k(O(),o,null,e),o;function O(){return n().forum.attribute("foskym-pagination.paginationPosition")}function k(t,i,s,n){var e="above"===t||"both"===t,o="under"===t||"both"===t;if(e||o){var a=J.component({state:n});if(s&&s.parent){var r,u=s.parent,l=f((Array.isArray(u),u));if(!l)return;var c=null!=(r=s.index)?r:l.indexOf(s.node);c<0&&(c=0),e&&l.splice(c,0,a),o&&l.splice(c+(e?2:1),0,a)}else{var p=f(i);if(!p)return;e&&p.unshift(a),o&&p.push(a)}}}}))}n().initializers.add("foskym/flarum-pagination",(function(){(0,e.extend)(h().prototype,"oninit",(function(){var t=this.user.preferences();this.userCustom=L()(t["foskym-pagination.userCustom"]),this.userPaginationOnLoading=L()(t["foskym-pagination.userPaginationOnLoading"])})),(0,e.extend)(h().prototype,"settingsItems",(function(t){Boolean(c().forum.attribute("foskym-pagination.canUserPref"))&&t.add("pagination_settings",f().component({label:c().translator.trans("foskym-pagination.forum.user.settings.head"),className:"SettingsPage-pagination"},this.Pagination_UserPrefItems().toArray()))})),h().prototype.Pagination_UserPrefItems=function(){var t=this,i=new(v());return i.add("foskym-pagination.userCustom",y().component({state:this.user.preferences()["foskym-pagination.userCustom"],onchange:function(i){t.UserCustom_Loading=!0,t.user.savePreferences({"foskym-pagination.userCustom":i}).then((function(){t.UserCustom_Loading=!1,m.redraw()}))},loading:this.UserCustom_Loading},c().translator.trans("foskym-pagination.forum.user.settings.userCustom"))),this.user.preferences()["foskym-pagination.userCustom"]&&i.add("foskym-pagination.userPaginationOnLoading",y().component({state:this.user.preferences()["foskym-pagination.userPaginationOnLoading"],onchange:function(i){t.userPaginationOnLoading_Loading=!0,t.user.savePreferences({"foskym-pagination.userPaginationOnLoading":i}).then((function(){t.userPaginationOnLoading_Loading=!1,m.redraw()}))},loading:this.userPaginationOnLoading_Loading},c().translator.trans("foskym-pagination.forum.user.settings.userPaginationOnLoading"))),i},O().prototype.initOptions=function(){this.options={cacheDiscussions:n().forum.attribute("foskym-pagination.cacheDiscussions"),perPage:n().forum.attribute("foskym-pagination.perPage"),perLoadMore:n().forum.attribute("foskym-pagination.perLoadMore"),perIndexInit:n().forum.attribute("foskym-pagination.perIndexInit"),leftEdges:4,rightEdges:5},this.usePaginationMode=function(){if(null===c().session.user)return c().forum.attribute("foskym-pagination.paginationOnLoading");var t=c().session.user.preferences();return c().forum.attribute("foskym-pagination.canUserPref")&&t["foskym-pagination.userCustom"]?!!t["foskym-pagination.userPaginationOnLoading"]:c().forum.attribute("foskym-pagination.paginationOnLoading")}(),this.lastTotalDiscussionCount=0,this.lastTotalPages=0,this.lastDiscussions=[],this.lastLoadedPage={},this.lastRequestParams={},this.optionInitialized=!0},(0,e.override)(O().prototype,"refreshParams",(function(t,i,s){var n=this;void 0===s&&(s=1);var e=t(i,s);return this.usePaginationMode&&"function"==typeof this.refresh?Promise.resolve(e).then((function(){return n.refresh(1)})):e})),(0,e.override)(O().prototype,"refresh",(function(t,i){var s=this;if(void 0===i&&(i=1),this.optionInitialized||this.initOptions(),!this.usePaginationMode)return this.pageSize=this.options.perLoadMore,t(i);var n=i;if(void 0===n||1===n){var e=function(){try{var t=new URL(window.location.href).searchParams.get("page"),i=parseInt(t,10);return Number.isFinite(i)&&i>0?i:null}catch(t){return null}}();e&&(n=e)}var o=this.requestParams(),a=JSON.stringify(o.include)!==JSON.stringify(this.lastRequestParams.include),r=JSON.stringify(o.filter)!==JSON.stringify(this.lastRequestParams.filter),u=o.sort!==this.lastRequestParams.sort;if(this.options.cacheDiscussions&&!(a||r||u)&&this.lastLoadedPage[n]){this.initialLoading=!1,this.loadingPrev=!1,this.loadingNext=!1,this.isRefreshing=!1,this.location={page:n},k(n,!0);var l=this.options.perPage*(n-1),c=this.options.perPage*n,p=this.lastDiscussions.slice(l,c);return p.payload={jsonapi:{totalResultsCount:this.totalDiscussionCount()}},this.pages=[],this.parseResults(this.location.page,p),Promise.resolve(p)}return this.initialLoading=!0,this.loadingPrev=!1,this.loadingNext=!1,this.isRefreshing=!0,this.clear(),this.location={page:n},k(n,!0),this.loadPage(n).then((function(t){s.pages=[],s.parseResults(s.location.page,t)})).finally((function(){s.initialLoading=!1,s.isRefreshing=!1}))})),(0,e.override)(O().prototype,"loadPage",(function(t,i){void 0===i&&(i=1);var s=this.requestParams();this.optionInitialized||this.initOptions(),this.lastRequestParams.include||(this.lastRequestParams=s);var e=n().preloadedApiDocument();if(e)return this.initialLoading=!1,this.isRefreshing=!1,this.totalDiscussionCount=L()(e.payload.jsonapi.totalResultsCount),this.lastTotalDiscussionCount=this.totalDiscussionCount(),Promise.resolve(e);if(!this.isRefreshing&&this.options.cacheDiscussions){var o=JSON.stringify(s.include)!==JSON.stringify(this.lastRequestParams.include),a=JSON.stringify(s.filter)!==JSON.stringify(this.lastRequestParams.filter),r=s.sort!==this.lastRequestParams.sort;if(!(o||a||r)&&this.lastLoadedPage[i]){var u=this.options.perPage*(i-1),l=this.options.perPage*i,c=this.lastDiscussions.slice(u,l);return c.payload={jsonapi:{totalResultsCount:this.totalDiscussionCount()}},this.initialLoading=!0,m.redraw(),new Promise((function(t){return setTimeout((function(){return t(c)}),50)}))}}var p,h,g=Array.isArray(s.include)?s.include.join(","):s.include;this.usePaginationMode?(p=this.options.perPage*(i-1),h=this.options.perPage):h=0==(p=this.options.perIndexInit*Math.min(i-1,1)+this.options.perLoadMore*Math.max(i-2,0))?this.options.perIndexInit:this.options.perLoadMore;var f=D({},s,{page:D({},s.page,{offset:p,limit:h}),include:g});return n().store.find(this.type,f)})),(0,e.override)(O().prototype,"getAllItems",(function(t){return"walsgit-discussion-cards"in flarum.extensions?this.extraDiscussions.concat(this.getPages(!0).map((function(t){return t.items})).flat()):t()})),(0,e.override)(O().prototype,"getPages",(function(t,i){var s=this;void 0===i&&(i=!1);var n=t();return"walsgit-discussion-cards"in flarum.extensions?i?n:[n.find((function(t){return t.number===s.location.page}))]:n})),(0,e.override)(O().prototype,"parseResults",(function(t,i,s){var n;if(!this.usePaginationMode)return t(i,s);var e=Number(i),o=(null==(n=s.payload)?void 0:n.links)||{},a={number:e,items:s,hasNext:!(null==o||!o.next),hasPrev:!(null==o||!o.prev)};if(this.hasPage=function(t){var i=this.getPages(!0);return 0!==i.length&&i.some((function(i){return i.number===t}))},this.hasPage(e)||this.pages.push(a),this.pages=this.pages.sort((function(t,i){return t.number-i.number})),this.location={page:e},this.totalDiscussionCount=L()(s.payload.jsonapi.totalResultsCount),this.options.cacheDiscussions)if(this.lastTotalDiscussionCount!==this.totalDiscussionCount()&&0!==this.lastTotalDiscussionCount||0===this.lastTotalDiscussionCount||this.isRefreshing)this.lastTotalDiscussionCount=this.totalDiscussionCount(),this.lastDiscussions=new Array(this.lastTotalDiscussionCount),this.lastLoadedPage={};else{var r;this.lastLoadedPage[e]=a;var u=this.options.perPage*(e-1),l=this.options.perPage*e;(r=this.lastDiscussions).splice.apply(r,[u,l-u].concat(s))}this.getTotalPages=function(){return Math.ceil(this.totalDiscussionCount()/this.options.perPage)},this.page=L()(a),this.perPage=L()(this.options.perPage),this.totalPages=L()(this.getTotalPages()),this.ctrl={scrollToTop:function(){var t=document.querySelector("#content > .IndexPage > .container"),i=document.querySelector("#header"),s=0;if(i&&(s=i.clientHeight),t){var n=t.getBoundingClientRect().top+window.scrollY-s;setTimeout((function(){return window.scrollTo({top:n,behavior:"smooth"})}),50)}}.bind(this),prevPage:function(){var t=this,i=this.page().number-1;i<1||(this.page(i),this.loadingPrev=!0,this.loadPage(i).then((function(s){t.parseResults(i,s),t.loadingPrev=!1,k(i,!0),t.ctrl.scrollToTop()})))}.bind(this),nextPage:function(){var t=this,i=this.page().number+1;i>this.totalPages()?i=this.totalPages():(this.page(i),this.loadingNext=!0,this.loadPage(i).then((function(s){t.parseResults(i,s),t.loadingNext=!1,k(i,!0),t.ctrl.scrollToTop()})))}.bind(this),toPage:function(t){var i=this,s=Number(t);this.page().number===s||s<1||s>this.totalPages()||(this.page(s),this.initialLoading=!0,this.loadPage(s).then((function(t){i.parseResults(s,t),i.initialLoading=!1,k(s,!0),i.ctrl.scrollToTop()})))}.bind(this),pageList:function(){for(var t=[],i=Math.max(parseInt(this.page().number)-this.options.leftEdges,1),s=Math.min(parseInt(this.page().number)+this.options.rightEdges,this.totalPages()),n=i;n<=s;n++)t.push(n);return t}.bind(this)},m.redraw()})),(0,e.override)(O().prototype,"addDiscussion",(function(t,i){var s=this;if(!this.usePaginationMode)return t(i);clearTimeout(this.__rtRefreshTimer),this.__rtRefreshTimer=setTimeout((function(){s.page=s.page||L()({number:1,items:[]}),s.location={page:1},s.refresh(1)}),50);var n=this.lastDiscussions.indexOf(i);-1!==n?(this.lastDiscussions.splice(n),this.lastDiscussions.unshift(i)):(this.lastDiscussions.unshift(i),this.lastTotalDiscussionCount++,this.totalDiscussionCount(this.lastTotalDiscussionCount)),m.redraw()})),(0,e.override)(O().prototype,"deleteDiscussion",(function(t,i){if(!this.usePaginationMode)return t(i);var s=this.lastDiscussions.indexOf(i);-1!==s&&(this.lastDiscussions.splice(s),this.lastTotalDiscussionCount--,this.totalDiscussionCount(this.lastTotalDiscussionCount)),m.redraw()})),(0,e.override)(O().prototype,"clear",(function(t){return this.usePaginationMode?(this.lastDiscussions=[],this.lastLoadedPage={},this.lastRequestParams={},this.lastTotalDiscussionCount=0,this.lastTotalPages=0,this.totalDiscussionCount=L()(0),t()):t()})),j(),(0,e.extend)(u(),"deleteAction",(function(){if(this.usePaginationMode&&n().discussions){var t=n().discussions.location.page;n().discussions.refresh(t)}})),(0,e.extend)(a().prototype,"onsubmit",(function(){this.usePaginationMode&&n().discussions&&n().discussions.refresh()}))}),-2)})(),module.exports=i})();
//# sourceMappingURL=forum.js.map