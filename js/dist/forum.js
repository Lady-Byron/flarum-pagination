(()=>{var t={n:n=>{var i=n&&n.__esModule?()=>n.default:()=>n;return t.d(i,{a:i}),i},d:(n,i)=>{for(var e in i)t.o(i,e)&&!t.o(n,e)&&Object.defineProperty(n,e,{enumerable:!0,get:i[e]})},o:(t,n)=>Object.prototype.hasOwnProperty.call(t,n),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},n={};(()=>{"use strict";t.r(n);const i=flarum.core.compat["common/app"];var e=t.n(i);const s=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/components/DiscussionComposer"];var a=t.n(o);const r=flarum.core.compat["forum/utils/DiscussionControls"];var u=t.n(r);const l=flarum.core.compat["forum/app"];var c=t.n(l);const p=flarum.core.compat["forum/components/SettingsPage"];var f=t.n(p);const g=flarum.core.compat["common/components/FieldSet"];var h=t.n(g);const d=flarum.core.compat["common/utils/ItemList"];var v=t.n(d);const y=flarum.core.compat["common/components/Switch"];var P=t.n(y);const b=flarum.core.compat["common/utils/Stream"];var L=t.n(b);function D(){return D=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var i=arguments[n];for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e])}return t},D.apply(this,arguments)}const C=flarum.core.compat["forum/states/DiscussionListState"];var O=t.n(C);function w(t,n){(null==n||n>t.length)&&(n=t.length);for(var i=0,e=new Array(n);i<n;i++)e[i]=t[i];return e}function k(t,n){void 0===n&&(n=!0);try{var i=new URL(window.location.href);t<=1?i.searchParams.delete("page"):i.searchParams.set("page",String(t));var e=i.pathname+i.search+i.hash,s=window&&window.m||null;s&&s.route&&"function"==typeof s.route.set?s.route.set(e,void 0,{replace:!0}):(n?history.replaceState:history.pushState).call(history,null,"",e)}catch(t){}}function A(t,n){try{var i,e=t.requestParams?t.requestParams():{},s={base:location.pathname,include:e.include||[],filter:e.filter||{},sort:e.sort||null,perPage:(null==(i=t.options)?void 0:i.perPage)||20,page:Number(n)||1};return"lbtc:dl:pagecache:"+JSON.stringify(s)}catch(t){return null}}function x(){O().prototype.initOptions=function(){this.options={cacheDiscussions:e().forum.attribute("foskym-pagination.cacheDiscussions"),perPage:e().forum.attribute("foskym-pagination.perPage"),perLoadMore:e().forum.attribute("foskym-pagination.perLoadMore"),perIndexInit:e().forum.attribute("foskym-pagination.perIndexInit"),leftEdges:4,rightEdges:5},this.usePaginationMode=function(){if(null===c().session.user)return c().forum.attribute("foskym-pagination.paginationOnLoading");var t=c().session.user.preferences();return c().forum.attribute("foskym-pagination.canUserPref")&&t["foskym-pagination.userCustom"]?!!t["foskym-pagination.userPaginationOnLoading"]:c().forum.attribute("foskym-pagination.paginationOnLoading")}(),this.lastTotalDiscussionCount=0,this.lastTotalPages=0,this.lastDiscussions=[],this.lastLoadedPage={},this.lastRequestParams={},this.optionInitialized=!0},(0,s.override)(O().prototype,"refreshParams",(function(t,n,i){var e=this;void 0===i&&(i=1);var s=t(n,i);return this.usePaginationMode&&"function"==typeof this.refresh?Promise.resolve(s).then((function(){return e.refresh(1)})):s})),(0,s.override)(O().prototype,"refresh",(function(t,n){var i=this;if(void 0===n&&(n=1),this.optionInitialized||this.initOptions(),!this.usePaginationMode)return this.pageSize=this.options.perLoadMore,t(n);var s=n;if(void 0===s||1===s){var o=function(){try{var t=new URL(window.location.href).searchParams.get("page"),n=parseInt(t,10);return Number.isFinite(n)&&n>0?n:null}catch(t){return null}}();o&&(s=o)}var a=function(t,n){try{var i,s=A(t,n);if(!s)return null;var o=sessionStorage.getItem(s);if(!o)return null;var a=JSON.parse(o);if(!a||!Array.isArray(a.ids)||!a.ids.length)return null;for(var r,u=t.type||"discussions",l=[],c=function(t,n){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(i)return(i=i.call(t)).next.bind(i);if(Array.isArray(t)||(i=function(t,n){if(t){if("string"==typeof t)return w(t,n);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?w(t,n):void 0}}(t))||n&&t&&"number"==typeof t.length){i&&(t=i);var e=0;return function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(a.ids);!(r=c()).done;){var p=r.value,f=e().store.getById&&e().store.getById(u,p)||e().store.getBy&&e().store.getBy(u,"id",p)||null;if(!f)return null;l.push(f)}var g=Math.ceil((a.total||0)/(a.perPage||(null==(i=t.options)?void 0:i.perPage)||20)),h={};n>1&&(h.prev=!0),n<g&&(h.next=!0);var m=l;return m.payload={jsonapi:{totalResultsCount:a.total||0},links:h},m}catch(t){return null}}(this,s);return a?(this.silentRestoreOnce=!0,this.initialLoading=!1,this.loadingPrev=!1,this.loadingNext=!1,this.isRefreshing=!1,this.location={page:s},k(s,!0),this.pages=[],this.parseResults(this.location.page,a),"undefined"!=typeof m&&m.redraw&&m.redraw(),setTimeout((function(){return i.silentRestoreOnce=!1}),0),Promise.resolve(a)):(this.initialLoading=!0,this.loadingPrev=!1,this.loadingNext=!1,this.isRefreshing=!0,this.clear(),this.location={page:s},k(s,!0),this.loadPage(s).then((function(t){i.pages=[],i.parseResults(i.location.page,t)})).finally((function(){i.initialLoading=!1,i.isRefreshing=!1})))})),(0,s.override)(O().prototype,"loadPage",(function(t,n){void 0===n&&(n=1);var i=this.requestParams();this.optionInitialized||this.initOptions(),this.lastRequestParams.include||(this.lastRequestParams=i);var s=e().preloadedApiDocument();if(s)return this.initialLoading=!1,this.isRefreshing=!1,this.totalDiscussionCount=L()(s.payload.jsonapi.totalResultsCount),this.lastTotalDiscussionCount=this.totalDiscussionCount(),Promise.resolve(s);if(!this.isRefreshing&&this.options.cacheDiscussions){var o=JSON.stringify(i.include)!==JSON.stringify(this.lastRequestParams.include),a=JSON.stringify(i.filter)!==JSON.stringify(this.lastRequestParams.filter),r=i.sort!==this.lastRequestParams.sort;if(!(o||a||r)&&this.lastLoadedPage[n]){var u=this.options.perPage*(n-1),l=this.options.perPage*n,c=this.lastDiscussions.slice(u,l);return c.payload={jsonapi:{totalResultsCount:this.totalDiscussionCount()}},this.initialLoading=!0,m.redraw(),new Promise((function(t){return setTimeout((function(){return t(c)}),50)}))}}var p,f,g=Array.isArray(i.include)?i.include.join(","):i.include;this.usePaginationMode?(p=this.options.perPage*(n-1),f=this.options.perPage):f=0==(p=this.options.perIndexInit*Math.min(n-1,1)+this.options.perLoadMore*Math.max(n-2,0))?this.options.perIndexInit:this.options.perLoadMore;var h=D({},i,{page:D({},i.page,{offset:p,limit:f}),include:g});return e().store.find(this.type,h)})),(0,s.override)(O().prototype,"getAllItems",(function(t){return"walsgit-discussion-cards"in flarum.extensions?this.extraDiscussions.concat(this.getPages(!0).map((function(t){return t.items})).flat()):t()})),(0,s.override)(O().prototype,"getPages",(function(t,n){var i=this;void 0===n&&(n=!1);var e=t();return"walsgit-discussion-cards"in flarum.extensions?n?e:[e.find((function(t){return t.number===i.location.page}))]:e})),(0,s.override)(O().prototype,"parseResults",(function(t,n,i){var e;if(!this.usePaginationMode)return t(n,i);var s=Number(n),o=(null==(e=i.payload)?void 0:e.links)||{},a={number:s,items:i,hasNext:!(null==o||!o.next),hasPrev:!(null==o||!o.prev)};if(this.hasPage=function(t){var n=this.getPages(!0);return 0!==n.length&&n.some((function(n){return n.number===t}))},this.hasPage(s)||this.pages.push(a),this.pages=this.pages.sort((function(t,n){return t.number-n.number})),this.location={page:s},this.totalDiscussionCount=L()(i.payload.jsonapi.totalResultsCount),this.options.cacheDiscussions)if(this.lastTotalDiscussionCount!==this.totalDiscussionCount()&&0!==this.lastTotalDiscussionCount||0===this.lastTotalDiscussionCount||this.isRefreshing)this.lastTotalDiscussionCount=this.totalDiscussionCount(),this.lastDiscussions=new Array(this.lastTotalDiscussionCount),this.lastLoadedPage={};else{var r;this.lastLoadedPage[s]=a;var u=this.options.perPage*(s-1),l=this.options.perPage*s;(r=this.lastDiscussions).splice.apply(r,[u,l-u].concat(i))}this.getTotalPages=function(){return Math.ceil(this.totalDiscussionCount()/this.options.perPage)},this.page=L()(a),this.perPage=L()(this.options.perPage),this.totalPages=L()(this.getTotalPages()),function(t,n,i){try{var e,s=A(t,n);if(!s)return;var o={ids:Array.isArray(i)?i.map((function(t){return t&&t.id&&t.id()})):[],total:t.totalDiscussionCount&&t.totalDiscussionCount()||i&&i.payload&&i.payload.jsonapi&&i.payload.jsonapi.totalResultsCount||0,ts:Date.now(),perPage:(null==(e=t.options)?void 0:e.perPage)||20};sessionStorage.setItem(s,JSON.stringify(o))}catch(t){}}(this,s,i),this.ctrl={scrollToTop:function(){var t=document.querySelector("#content > .IndexPage > .container"),n=document.querySelector("#header"),i=0;if(n&&(i=n.clientHeight),t){var e=t.getBoundingClientRect().top+window.scrollY-i;setTimeout((function(){return window.scrollTo({top:e,behavior:"smooth"})}),50)}}.bind(this),prevPage:function(){var t=this,n=this.page().number-1;n<1||(this.page(n),this.loadingPrev=!0,this.loadPage(n).then((function(i){t.parseResults(n,i),t.loadingPrev=!1,k(n,!0),t.ctrl.scrollToTop()})))}.bind(this),nextPage:function(){var t=this,n=this.page().number+1;n>this.totalPages()?n=this.totalPages():(this.page(n),this.loadingNext=!0,this.loadPage(n).then((function(i){t.parseResults(n,i),t.loadingNext=!1,k(n,!0),t.ctrl.scrollToTop()})))}.bind(this),toPage:function(t){var n=this,i=Number(t);this.page().number===i||i<1||i>this.totalPages()||(this.page(i),this.initialLoading=!0,this.loadPage(i).then((function(t){n.parseResults(i,t),n.initialLoading=!1,k(i,!0),n.ctrl.scrollToTop()})))}.bind(this),pageList:function(){for(var t=[],n=Math.max(parseInt(this.page().number)-this.options.leftEdges,1),i=Math.min(parseInt(this.page().number)+this.options.rightEdges,this.totalPages()),e=n;e<=i;e++)t.push(e);return t}.bind(this)},m.redraw()})),(0,s.override)(O().prototype,"addDiscussion",(function(t,n){var i=this;if(!this.usePaginationMode)return t(n);clearTimeout(this.__rtRefreshTimer),this.__rtRefreshTimer=setTimeout((function(){i.page=i.page||L()({number:1,items:[]}),i.location={page:1},i.refresh(1)}),50);var e=this.lastDiscussions.indexOf(n);-1!==e?(this.lastDiscussions.splice(e),this.lastDiscussions.unshift(n)):(this.lastDiscussions.unshift(n),this.lastTotalDiscussionCount++,this.totalDiscussionCount(this.lastTotalDiscussionCount)),m.redraw()})),(0,s.override)(O().prototype,"deleteDiscussion",(function(t,n){if(!this.usePaginationMode)return t(n);var i=this.lastDiscussions.indexOf(n);-1!==i&&(this.lastDiscussions.splice(i),this.lastTotalDiscussionCount--,this.totalDiscussionCount(this.lastTotalDiscussionCount)),m.redraw()})),(0,s.override)(O().prototype,"clear",(function(t){return this.usePaginationMode?(this.lastDiscussions=[],this.lastLoadedPage={},this.lastRequestParams={},this.lastTotalDiscussionCount=0,this.lastTotalPages=0,this.totalDiscussionCount=L()(0),t()):t()}))}const I=flarum.core.compat["forum/components/DiscussionList"];var S=t.n(I);const R=flarum.core.compat["forum/components/DiscussionListItem"];var T=t.n(R);const N=flarum.core.compat["common/utils/classList"];var M=t.n(N);function B(t,n){return B=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,n){return t.__proto__=n,t},B(t,n)}const j=flarum.core.compat["common/Component"];var _=t.n(j);const J=flarum.core.compat["common/components/Button"];var q=t.n(J),F=function(t){var n,i;function e(){for(var n,i=arguments.length,e=new Array(i),s=0;s<i;s++)e[s]=arguments[s];return(n=t.call.apply(t,[this].concat(e))||this).attrs=void 0,n}i=t,(n=e).prototype=Object.create(i.prototype),n.prototype.constructor=n,B(n,i);var s=e.prototype;return s.view=function(t){var n=this.attrs.state;return m("div",{className:"Pagination"},m("ul",{class:"IndexPage-toolbar-view"},m("li",null,this.buttonFirst()),m("li",null,this.buttonBack()),n.ctrl.pageList().map((function(t){return m("li",null,m(q(),{title:t,className:n.page().number==t?"Button Button--primary Button--active":"Button",onclick:function(){n.ctrl.toPage(t)}},t))})),m("li",null,this.buttonNext()),m("li",null,this.buttonLast()),m("li",null,this.inputJump()),m("li",null,this.buttonJump())))},s.buttonFirst=function(){var t=this.attrs.state;return q().component({title:"First",icon:"fa fa-angle-double-left fas fa-angles-left",className:"Button Button--icon",onclick:function(){t.ctrl.toPage(1)},disabled:1==t.page().number})},s.buttonBack=function(){var t=this.attrs.state;return q().component({title:"Back",icon:"fa fa-angle-left fas",className:"Button Button--icon",onclick:function(){var n=t.page().number;t.ctrl.toPage(parseInt(n)-1)},disabled:1==t.page().number})},s.buttonNext=function(){var t=this.attrs.state;return q().component({title:"Next",icon:"fa fa-angle-right fas",className:"Button Button--icon",onclick:function(){var n=t.page().number;t.ctrl.toPage(parseInt(n)+1)},disabled:t.page().number==t.totalPages()})},s.buttonLast=function(){var t=this.attrs.state;return q().component({title:"Last",icon:"fa fa-angle-double-right fas fa-angles-right",className:"Button Button--icon",onclick:function(){var n=parseInt(t.totalPages());t.ctrl.toPage(n)},disabled:t.page().number==t.totalPages()})},s.JumpFunc=function(){var t,n=this.attrs.state,i=parseInt(null==(t=document.getElementById("pagination-inputJump"))?void 0:t.value);Number.isFinite(i)&&Number.isSafeInteger(i)&&i!=n.page().number&&1<=i&&i<=n.totalPages()&&n.ctrl.toPage(i)},s.inputJump=function(){var t=this,n=this.attrs.state;return m("input.FromControl",{id:"pagination-inputJump",placeholder:void 0===n.page().number?"":""+n.page().number,onkeydown:function(n){n.redraw=!1,13==n.keyCode&&(n.redraw=!0,t.JumpFunc())}})},s.buttonJump=function(){return q().component({title:"Jump",icon:"fa fa-paper-plane fas",className:"Button Button--icon",onclick:this.JumpFunc.bind(this)})},e}(_());function U(){(0,s.override)(S().prototype,"view",(function(t){var n,i,s=null==(n=this.attrs)?void 0:n.state,o=t();if(o.attrs=o.attrs||{},o.attrs.className=M()("DiscussionList",{"DiscussionList--searchResults":null==s||null==s.isSearchResults?void 0:s.isSearchResults()},o.attrs.className),null!=s&&s.silentRestoreOnce){var a=function(t){return t&&"object"==typeof t&&t.attrs&&(n=t.attrs,String(n&&(n.className||n.class)||"")).includes("LoadingIndicator");var n};!function t(n){if(n)if(Array.isArray(n))for(var i=n.length-1;i>=0;i--){var e=n[i];a(e)?n.splice(i,1):t(e)}else if("string"!=typeof n&&"number"!=typeof n){var s,o=(s=n,Array.isArray(s)?s:s&&Array.isArray(s.children)?s.children:null);if(o)for(var r=o.length-1;r>=0;r--){var u=o[r];a(u)?o.splice(r,1):t(u)}}}(o)}if(null==s||!s.usePaginationMode||null!=s.isLoading&&s.isLoading()||null!=s.isEmpty&&s.isEmpty())return o;var r="walsgit-discussion-cards"in flarum.extensions,u=(null==(i=s.options)?void 0:i.perPage)||0,l=s.page||1,c=(null==s.getParams?void 0:s.getParams())||{},p=s.getPages?s.getPages(!0):[],f=[];if(Array.isArray(p)&&p.length){var g=p.find((function(t){var n;return(null==t?void 0:t.number)===(null==(n=s.location)?void 0:n.page)}))||p[0];g&&Array.isArray(g.items)&&(f=g.items)}var h=f.length?f.map((function(t,n){return m("li",{key:t.id(),"data-id":t.id(),role:"article","aria-setsize":-1,"aria-posinset":l*u+n},m(T(),{discussion:t,params:c}))})):null,d=function(t){return Array.isArray(t)?t:t&&Array.isArray(t.children)?t.children:null},v=[];if(function t(n,i,e){if(n)if(Array.isArray(n))for(var s=0;s<n.length;s++)t(n[s],n,s);else if("string"!=typeof n&&"number"!=typeof n){(r=n)&&"ul"===r.tag&&(u=r.attrs,String(u&&(u.className||u.class)||"")).includes("DiscussionList-discussions")&&v.push({node:n,parent:i,index:e});var o=d(n);if(o)for(var a=0;a<o.length;a++)t(o[a],n,a)}var r,u}(o,null,null),r)return k(w(),o,v.length?v[0]:null,s),o;if(v.length>0){var y=v.find((function(t){var n=d(t.node);return n&&n.some((function(t){return t&&"li"===t.tag}))}))||v.find((function(t){var n;return(null==(n=t.node)?void 0:n.attrs)&&"aria-busy"in t.node.attrs}))||v[0];if(h){var P=d(y.node);P?P.splice.apply(P,[0,P.length].concat(h)):y.node.children=h}for(var b=v.length-1;b>=0;b--){var L,D=v[b];if(D!==y){var C=d((Array.isArray(D.parent),D.parent));if(C){var O=null!=(L=D.index)?L:C.indexOf(D.node);O>=0&&C[O]===D.node&&((d(D.node)||[]).some((function(t){return t&&"li"===t.tag}))||C.splice(O,1))}}}return k(w(),o,y,s),o}return k(w(),o,null,s),o;function w(){return e().forum.attribute("foskym-pagination.paginationPosition")}function k(t,n,i,e){var s="above"===t||"both"===t,o="under"===t||"both"===t;if(s||o){var a=F.component({state:e});if(i&&i.parent){var r,u=i.parent,l=d((Array.isArray(u),u));if(!l)return;var c=null!=(r=i.index)?r:l.indexOf(i.node);c<0&&(c=0),s&&l.splice(c,0,a),o&&l.splice(c+(s?2:1),0,a)}else{var p=d(n);if(!p)return;s&&p.unshift(a),o&&p.push(a)}}}}))}e().initializers.add("foskym/flarum-pagination",(function(){(0,s.extend)(f().prototype,"oninit",(function(){var t=this.user.preferences();this.userCustom=L()(t["foskym-pagination.userCustom"]),this.userPaginationOnLoading=L()(t["foskym-pagination.userPaginationOnLoading"])})),(0,s.extend)(f().prototype,"settingsItems",(function(t){Boolean(c().forum.attribute("foskym-pagination.canUserPref"))&&t.add("pagination_settings",h().component({label:c().translator.trans("foskym-pagination.forum.user.settings.head"),className:"SettingsPage-pagination"},this.Pagination_UserPrefItems().toArray()))})),f().prototype.Pagination_UserPrefItems=function(){var t=this,n=new(v());return n.add("foskym-pagination.userCustom",P().component({state:this.user.preferences()["foskym-pagination.userCustom"],onchange:function(n){t.UserCustom_Loading=!0,t.user.savePreferences({"foskym-pagination.userCustom":n}).then((function(){t.UserCustom_Loading=!1,m.redraw()}))},loading:this.UserCustom_Loading},c().translator.trans("foskym-pagination.forum.user.settings.userCustom"))),this.user.preferences()["foskym-pagination.userCustom"]&&n.add("foskym-pagination.userPaginationOnLoading",P().component({state:this.user.preferences()["foskym-pagination.userPaginationOnLoading"],onchange:function(n){t.userPaginationOnLoading_Loading=!0,t.user.savePreferences({"foskym-pagination.userPaginationOnLoading":n}).then((function(){t.userPaginationOnLoading_Loading=!1,m.redraw()}))},loading:this.userPaginationOnLoading_Loading},c().translator.trans("foskym-pagination.forum.user.settings.userPaginationOnLoading"))),n},x(),U(),(0,s.extend)(u(),"deleteAction",(function(){if(this.usePaginationMode&&e().discussions){var t=e().discussions.location.page;e().discussions.refresh(t)}})),(0,s.extend)(a().prototype,"onsubmit",(function(){this.usePaginationMode&&e().discussions&&e().discussions.refresh()}))}),-2)})(),module.exports=n})();
//# sourceMappingURL=forum.js.map