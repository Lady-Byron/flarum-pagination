(()=>{var t={n:n=>{var i=n&&n.__esModule?()=>n.default:()=>n;return t.d(i,{a:i}),i},d:(n,i)=>{for(var s in i)t.o(i,s)&&!t.o(n,s)&&Object.defineProperty(n,s,{enumerable:!0,get:i[s]})},o:(t,n)=>Object.prototype.hasOwnProperty.call(t,n),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},n={};(()=>{"use strict";t.r(n);const i=flarum.core.compat["common/app"];var s=t.n(i);const e=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/components/DiscussionComposer"];var a=t.n(o);const r=flarum.core.compat["forum/utils/DiscussionControls"];var u=t.n(r);const l=flarum.core.compat["forum/app"];var c=t.n(l);const p=flarum.core.compat["forum/components/SettingsPage"];var f=t.n(p);const h=flarum.core.compat["common/components/FieldSet"];var g=t.n(h);const d=flarum.core.compat["common/utils/ItemList"];var v=t.n(d);const y=flarum.core.compat["common/components/Switch"];var P=t.n(y);const b=flarum.core.compat["common/utils/Stream"];var L=t.n(b);function D(){return D=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var i=arguments[n];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(t[s]=i[s])}return t},D.apply(this,arguments)}const O=flarum.core.compat["forum/states/DiscussionListState"];var C=t.n(O);function w(t,n){(null==n||n>t.length)&&(n=t.length);for(var i=0,s=new Array(n);i<n;i++)s[i]=t[i];return s}function S(t,n){void 0===n&&(n=!0);try{var i=new URL(window.location.href);t<=1?i.searchParams.delete("page"):i.searchParams.set("page",String(t));var s=i.pathname+i.search+i.hash,e=window&&window.m||null;e&&e.route&&"function"==typeof e.route.set?e.route.set(s,void 0,{replace:!0}):(n?history.replaceState:history.pushState).call(history,null,"",s)}catch(t){}}function k(t,n){try{var i,s=t.requestParams?t.requestParams():{},e={base:location.pathname,include:s.include||[],filter:s.filter||{},sort:s.sort||null,perPage:(null==(i=t.options)?void 0:i.perPage)||20,page:Number(n)||1};return"lbtc:dl:pagecache:"+JSON.stringify(e)}catch(t){return null}}function A(t,n){try{var i=k(t,n);i&&sessionStorage.removeItem(i)}catch(t){}}function x(){C().prototype.initOptions=function(){this.options={cacheDiscussions:s().forum.attribute("foskym-pagination.cacheDiscussions"),perPage:s().forum.attribute("foskym-pagination.perPage"),perLoadMore:s().forum.attribute("foskym-pagination.perLoadMore"),perIndexInit:s().forum.attribute("foskym-pagination.perIndexInit"),leftEdges:4,rightEdges:5},this.usePaginationMode=function(){if(null===c().session.user)return c().forum.attribute("foskym-pagination.paginationOnLoading");var t=c().session.user.preferences();return c().forum.attribute("foskym-pagination.canUserPref")&&t["foskym-pagination.userCustom"]?!!t["foskym-pagination.userPaginationOnLoading"]:c().forum.attribute("foskym-pagination.paginationOnLoading")}(),this.lastTotalDiscussionCount=0,this.lastTotalPages=0,this.lastDiscussions=[],this.lastLoadedPage={},this.lastRequestParams={},this.optionInitialized=!0},(0,e.override)(C().prototype,"refreshParams",(function(t,n,i){var s=this;void 0===i&&(i=1);var e=t(n,i);return this.usePaginationMode&&"function"==typeof this.refresh?(this.__bypassSessionOnce=!0,A(this,1),Promise.resolve(e).then((function(){return s.refresh(1)}))):e})),(0,e.override)(C().prototype,"refresh",(function(t,n){var i=this;if(void 0===n&&(n=1),this.optionInitialized||this.initOptions(),!this.usePaginationMode)return this.pageSize=this.options.perLoadMore,t(n);var e=n;if(void 0===e||1===e){var o=function(){try{var t=new URL(window.location.href).searchParams.get("page"),n=parseInt(t,10);return Number.isFinite(n)&&n>0?n:null}catch(t){return null}}();o&&(e=o)}if(!this.__bypassSessionOnce){var a=function(t,n){try{var i,e=k(t,n);if(!e)return null;var o=sessionStorage.getItem(e);if(!o)return null;var a=JSON.parse(o);if(!a||!Array.isArray(a.ids)||!a.ids.length)return null;for(var r,u=t.type||"discussions",l=[],c=function(t,n){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(i)return(i=i.call(t)).next.bind(i);if(Array.isArray(t)||(i=function(t,n){if(t){if("string"==typeof t)return w(t,n);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?w(t,n):void 0}}(t))||n&&t&&"number"==typeof t.length){i&&(t=i);var s=0;return function(){return s>=t.length?{done:!0}:{done:!1,value:t[s++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(a.ids);!(r=c()).done;){var p=r.value,f=s().store.getById&&s().store.getById(u,p)||s().store.getBy&&s().store.getBy(u,"id",p)||null;if(!f)return null;l.push(f)}var h=Math.ceil((a.total||0)/(a.perPage||(null==(i=t.options)?void 0:i.perPage)||20)),g={};n>1&&(g.prev=!0),n<h&&(g.next=!0);var m=l;return m.payload={jsonapi:{totalResultsCount:a.total||0},links:g},m}catch(t){return null}}(this,e);if(a)return this.silentRestoreOnce=!0,this.initialLoading=!1,this.loadingPrev=!1,this.loadingNext=!1,this.isRefreshing=!1,this.location={page:e},S(e,!0),this.pages=[],this.parseResults(this.location.page,a),"undefined"!=typeof m&&m.redraw&&m.redraw(),setTimeout((function(){return i.silentRestoreOnce=!1}),0),Promise.resolve(a)}return this.__bypassSessionOnce=!1,this.initialLoading=!0,this.loadingPrev=!1,this.loadingNext=!1,this.isRefreshing=!0,this.clear(),this.location={page:e},S(e,!0),this.loadPage(e).then((function(t){i.pages=[],i.parseResults(i.location.page,t)})).finally((function(){i.initialLoading=!1,i.isRefreshing=!1}))})),(0,e.override)(C().prototype,"loadPage",(function(t,n){void 0===n&&(n=1);var i=this.requestParams();this.optionInitialized||this.initOptions(),this.lastRequestParams.include||(this.lastRequestParams=i);var e=s().preloadedApiDocument();if(e)return this.initialLoading=!1,this.isRefreshing=!1,this.totalDiscussionCount=L()(e.payload.jsonapi.totalResultsCount),this.lastTotalDiscussionCount=this.totalDiscussionCount(),Promise.resolve(e);if(!this.isRefreshing&&this.options.cacheDiscussions){var o=JSON.stringify(i.include)!==JSON.stringify(this.lastRequestParams.include),a=JSON.stringify(i.filter)!==JSON.stringify(this.lastRequestParams.filter),r=i.sort!==this.lastRequestParams.sort;if(!(o||a||r)&&this.lastLoadedPage[n]){var u=this.options.perPage*(n-1),l=this.options.perPage*n,c=this.lastDiscussions.slice(u,l);return c.payload={jsonapi:{totalResultsCount:this.totalDiscussionCount()}},this.initialLoading=!0,m.redraw(),new Promise((function(t){return setTimeout((function(){return t(c)}),50)}))}}var p,f,h=Array.isArray(i.include)?i.include.join(","):i.include;this.usePaginationMode?(p=this.options.perPage*(n-1),f=this.options.perPage):f=0==(p=this.options.perIndexInit*Math.min(n-1,1)+this.options.perLoadMore*Math.max(n-2,0))?this.options.perIndexInit:this.options.perLoadMore;var g=D({},i,{page:D({},i.page,{offset:p,limit:f}),include:h});return s().store.find(this.type,g)})),(0,e.override)(C().prototype,"getAllItems",(function(t){return"walsgit-discussion-cards"in flarum.extensions?this.extraDiscussions.concat(this.getPages(!0).map((function(t){return t.items})).flat()):t()})),(0,e.override)(C().prototype,"getPages",(function(t,n){var i=this;void 0===n&&(n=!1);var s=t();return"walsgit-discussion-cards"in flarum.extensions?n?s:[s.find((function(t){return t.number===i.location.page}))]:s})),(0,e.override)(C().prototype,"parseResults",(function(t,n,i){var s;if(!this.usePaginationMode)return t(n,i);var e=Number(n),o=(null==(s=i.payload)?void 0:s.links)||{},a={number:e,items:i,hasNext:!(null==o||!o.next),hasPrev:!(null==o||!o.prev)};if(this.hasPage=function(t){var n=this.getPages(!0);return 0!==n.length&&n.some((function(n){return n.number===t}))},this.hasPage(e)||this.pages.push(a),this.pages=this.pages.sort((function(t,n){return t.number-n.number})),this.location={page:e},this.totalDiscussionCount=L()(i.payload.jsonapi.totalResultsCount),this.options.cacheDiscussions)if(this.lastTotalDiscussionCount!==this.totalDiscussionCount()&&0!==this.lastTotalDiscussionCount||0===this.lastTotalDiscussionCount||this.isRefreshing)this.lastTotalDiscussionCount=this.totalDiscussionCount(),this.lastDiscussions=new Array(this.lastTotalDiscussionCount),this.lastLoadedPage={};else{var r;this.lastLoadedPage[e]=a;var u=this.options.perPage*(e-1),l=this.options.perPage*e;(r=this.lastDiscussions).splice.apply(r,[u,l-u].concat(i))}this.getTotalPages=function(){return Math.ceil(this.totalDiscussionCount()/this.options.perPage)},this.page=L()(a),this.perPage=L()(this.options.perPage),this.totalPages=L()(this.getTotalPages()),function(t,n,i){try{var s,e=k(t,n);if(!e)return;var o={ids:Array.isArray(i)?i.map((function(t){return t&&t.id&&t.id()})):[],total:t.totalDiscussionCount&&t.totalDiscussionCount()||i&&i.payload&&i.payload.jsonapi&&i.payload.jsonapi.totalResultsCount||0,ts:Date.now(),perPage:(null==(s=t.options)?void 0:s.perPage)||20};sessionStorage.setItem(e,JSON.stringify(o))}catch(t){}}(this,e,i),this.ctrl={scrollToTop:function(){var t=document.querySelector("#content > .IndexPage > .container"),n=document.querySelector("#header"),i=0;if(n&&(i=n.clientHeight),t){var s=t.getBoundingClientRect().top+window.scrollY-i;setTimeout((function(){return window.scrollTo({top:s,behavior:"smooth"})}),50)}}.bind(this),prevPage:function(){var t=this,n=this.page().number-1;n<1||(this.page(n),this.loadingPrev=!0,this.loadPage(n).then((function(i){t.parseResults(n,i),t.loadingPrev=!1,S(n,!0),t.ctrl.scrollToTop()})))}.bind(this),nextPage:function(){var t=this,n=this.page().number+1;n>this.totalPages()?n=this.totalPages():(this.page(n),this.loadingNext=!0,this.loadPage(n).then((function(i){t.parseResults(n,i),t.loadingNext=!1,S(n,!0),t.ctrl.scrollToTop()})))}.bind(this),toPage:function(t){var n=this,i=Number(t);this.page().number===i||i<1||i>this.totalPages()||(this.page(i),this.initialLoading=!0,this.loadPage(i).then((function(t){n.parseResults(i,t),n.initialLoading=!1,S(i,!0),n.ctrl.scrollToTop()})))}.bind(this),pageList:function(){for(var t=[],n=Math.max(parseInt(this.page().number)-this.options.leftEdges,1),i=Math.min(parseInt(this.page().number)+this.options.rightEdges,this.totalPages()),s=n;s<=i;s++)t.push(s);return t}.bind(this)},m.redraw()})),(0,e.override)(C().prototype,"addDiscussion",(function(t,n){var i=this;if(!this.usePaginationMode)return t(n);clearTimeout(this.__rtRefreshTimer),this.__rtRefreshTimer=setTimeout((function(){i.page=i.page||L()({number:1,items:[]}),i.location={page:1},i.__bypassSessionOnce=!0,A(i,1),i.refresh(1)}),50);var s=this.lastDiscussions.indexOf(n);-1!==s?(this.lastDiscussions.splice(s),this.lastDiscussions.unshift(n)):(this.lastDiscussions.unshift(n),this.lastTotalDiscussionCount++,this.totalDiscussionCount(this.lastTotalDiscussionCount)),m.redraw()})),(0,e.override)(C().prototype,"deleteDiscussion",(function(t,n){if(!this.usePaginationMode)return t(n);var i=this.lastDiscussions.indexOf(n);-1!==i&&(this.lastDiscussions.splice(i),this.lastTotalDiscussionCount--,this.totalDiscussionCount(this.lastTotalDiscussionCount)),m.redraw()})),(0,e.override)(C().prototype,"clear",(function(t){return this.usePaginationMode?(this.lastDiscussions=[],this.lastLoadedPage={},this.lastRequestParams={},this.lastTotalDiscussionCount=0,this.lastTotalPages=0,this.totalDiscussionCount=L()(0),t()):t()}))}const I=flarum.core.compat["forum/components/DiscussionList"];var R=t.n(I);const T=flarum.core.compat["forum/components/DiscussionListItem"];var N=t.n(T);const _=flarum.core.compat["common/utils/classList"];var M=t.n(_);function B(t,n){return B=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,n){return t.__proto__=n,t},B(t,n)}const j=flarum.core.compat["common/Component"];var J=t.n(j);const q=flarum.core.compat["common/components/Button"];var F=t.n(q),U=function(t){var n,i;function s(){for(var n,i=arguments.length,s=new Array(i),e=0;e<i;e++)s[e]=arguments[e];return(n=t.call.apply(t,[this].concat(s))||this).attrs=void 0,n}i=t,(n=s).prototype=Object.create(i.prototype),n.prototype.constructor=n,B(n,i);var e=s.prototype;return e.view=function(t){var n=this.attrs.state;return m("div",{className:"Pagination"},m("ul",{class:"IndexPage-toolbar-view"},m("li",null,this.buttonFirst()),m("li",null,this.buttonBack()),n.ctrl.pageList().map((function(t){return m("li",null,m(F(),{title:t,className:n.page().number==t?"Button Button--primary Button--active":"Button",onclick:function(){n.ctrl.toPage(t)}},t))})),m("li",null,this.buttonNext()),m("li",null,this.buttonLast()),m("li",null,this.inputJump()),m("li",null,this.buttonJump())))},e.buttonFirst=function(){var t=this.attrs.state;return F().component({title:"First",icon:"fa fa-angle-double-left fas fa-angles-left",className:"Button Button--icon",onclick:function(){t.ctrl.toPage(1)},disabled:1==t.page().number})},e.buttonBack=function(){var t=this.attrs.state;return F().component({title:"Back",icon:"fa fa-angle-left fas",className:"Button Button--icon",onclick:function(){var n=t.page().number;t.ctrl.toPage(parseInt(n)-1)},disabled:1==t.page().number})},e.buttonNext=function(){var t=this.attrs.state;return F().component({title:"Next",icon:"fa fa-angle-right fas",className:"Button Button--icon",onclick:function(){var n=t.page().number;t.ctrl.toPage(parseInt(n)+1)},disabled:t.page().number==t.totalPages()})},e.buttonLast=function(){var t=this.attrs.state;return F().component({title:"Last",icon:"fa fa-angle-double-right fas fa-angles-right",className:"Button Button--icon",onclick:function(){var n=parseInt(t.totalPages());t.ctrl.toPage(n)},disabled:t.page().number==t.totalPages()})},e.JumpFunc=function(){var t,n=this.attrs.state,i=parseInt(null==(t=document.getElementById("pagination-inputJump"))?void 0:t.value);Number.isFinite(i)&&Number.isSafeInteger(i)&&i!=n.page().number&&1<=i&&i<=n.totalPages()&&n.ctrl.toPage(i)},e.inputJump=function(){var t=this,n=this.attrs.state;return m("input.FromControl",{id:"pagination-inputJump",placeholder:void 0===n.page().number?"":""+n.page().number,onkeydown:function(n){n.redraw=!1,13==n.keyCode&&(n.redraw=!0,t.JumpFunc())}})},e.buttonJump=function(){return F().component({title:"Jump",icon:"fa fa-paper-plane fas",className:"Button Button--icon",onclick:this.JumpFunc.bind(this)})},s}(J());function E(){(0,e.override)(R().prototype,"view",(function(t){var n,i,e=null==(n=this.attrs)?void 0:n.state,o=t();if(o.attrs=o.attrs||{},o.attrs.className=M()("DiscussionList",{"DiscussionList--searchResults":null==e||null==e.isSearchResults?void 0:e.isSearchResults()},o.attrs.className),null!=e&&e.silentRestoreOnce){var a=function(t){return t&&"object"==typeof t&&t.attrs&&(n=t.attrs,String(n&&(n.className||n.class)||"")).includes("LoadingIndicator");var n};!function t(n){if(n)if(Array.isArray(n))for(var i=n.length-1;i>=0;i--){var s=n[i];a(s)?n.splice(i,1):t(s)}else if("string"!=typeof n&&"number"!=typeof n){var e,o=(e=n,Array.isArray(e)?e:e&&Array.isArray(e.children)?e.children:null);if(o)for(var r=o.length-1;r>=0;r--){var u=o[r];a(u)?o.splice(r,1):t(u)}}}(o)}if(null==e||!e.usePaginationMode||null!=e.isLoading&&e.isLoading()||null!=e.isEmpty&&e.isEmpty())return o;var r="walsgit-discussion-cards"in flarum.extensions,u=(null==(i=e.options)?void 0:i.perPage)||0,l=e.page||1,c=(null==e.getParams?void 0:e.getParams())||{},p=e.getPages?e.getPages(!0):[],f=[];if(Array.isArray(p)&&p.length){var h=p.find((function(t){var n;return(null==t?void 0:t.number)===(null==(n=e.location)?void 0:n.page)}))||p[0];h&&Array.isArray(h.items)&&(f=h.items)}var g=f.length?f.map((function(t,n){return m("li",{key:t.id(),"data-id":t.id(),role:"article","aria-setsize":-1,"aria-posinset":l*u+n},m(N(),{discussion:t,params:c}))})):null,d=function(t){return Array.isArray(t)?t:t&&Array.isArray(t.children)?t.children:null},v=[];if(function t(n,i,s){if(n)if(Array.isArray(n))for(var e=0;e<n.length;e++)t(n[e],n,e);else if("string"!=typeof n&&"number"!=typeof n){(r=n)&&"ul"===r.tag&&(u=r.attrs,String(u&&(u.className||u.class)||"")).includes("DiscussionList-discussions")&&v.push({node:n,parent:i,index:s});var o=d(n);if(o)for(var a=0;a<o.length;a++)t(o[a],n,a)}var r,u}(o,null,null),r)return S(w(),o,v.length?v[0]:null,e),o;if(v.length>0){var y=v.find((function(t){var n=d(t.node);return n&&n.some((function(t){return t&&"li"===t.tag}))}))||v.find((function(t){var n;return(null==(n=t.node)?void 0:n.attrs)&&"aria-busy"in t.node.attrs}))||v[0];if(g){var P=d(y.node);P?P.splice.apply(P,[0,P.length].concat(g)):y.node.children=g}for(var b=v.length-1;b>=0;b--){var L,D=v[b];if(D!==y){var O=d((Array.isArray(D.parent),D.parent));if(O){var C=null!=(L=D.index)?L:O.indexOf(D.node);C>=0&&O[C]===D.node&&((d(D.node)||[]).some((function(t){return t&&"li"===t.tag}))||O.splice(C,1))}}}return S(w(),o,y,e),o}return S(w(),o,null,e),o;function w(){return s().forum.attribute("foskym-pagination.paginationPosition")}function S(t,n,i,s){var e="above"===t||"both"===t,o="under"===t||"both"===t;if(e||o){var a=U.component({state:s});if(i&&i.parent){var r,u=i.parent,l=d((Array.isArray(u),u));if(!l)return;var c=null!=(r=i.index)?r:l.indexOf(i.node);c<0&&(c=0),e&&l.splice(c,0,a),o&&l.splice(c+(e?2:1),0,a)}else{var p=d(n);if(!p)return;e&&p.unshift(a),o&&p.push(a)}}}}))}s().initializers.add("foskym/flarum-pagination",(function(){(0,e.extend)(f().prototype,"oninit",(function(){var t=this.user.preferences();this.userCustom=L()(t["foskym-pagination.userCustom"]),this.userPaginationOnLoading=L()(t["foskym-pagination.userPaginationOnLoading"])})),(0,e.extend)(f().prototype,"settingsItems",(function(t){Boolean(c().forum.attribute("foskym-pagination.canUserPref"))&&t.add("pagination_settings",g().component({label:c().translator.trans("foskym-pagination.forum.user.settings.head"),className:"SettingsPage-pagination"},this.Pagination_UserPrefItems().toArray()))})),f().prototype.Pagination_UserPrefItems=function(){var t=this,n=new(v());return n.add("foskym-pagination.userCustom",P().component({state:this.user.preferences()["foskym-pagination.userCustom"],onchange:function(n){t.UserCustom_Loading=!0,t.user.savePreferences({"foskym-pagination.userCustom":n}).then((function(){t.UserCustom_Loading=!1,m.redraw()}))},loading:this.UserCustom_Loading},c().translator.trans("foskym-pagination.forum.user.settings.userCustom"))),this.user.preferences()["foskym-pagination.userCustom"]&&n.add("foskym-pagination.userPaginationOnLoading",P().component({state:this.user.preferences()["foskym-pagination.userPaginationOnLoading"],onchange:function(n){t.userPaginationOnLoading_Loading=!0,t.user.savePreferences({"foskym-pagination.userPaginationOnLoading":n}).then((function(){t.userPaginationOnLoading_Loading=!1,m.redraw()}))},loading:this.userPaginationOnLoading_Loading},c().translator.trans("foskym-pagination.forum.user.settings.userPaginationOnLoading"))),n},x(),E(),(0,e.extend)(u(),"deleteAction",(function(){if(this.usePaginationMode&&s().discussions){var t=s().discussions.location.page;s().discussions.refresh(t)}})),(0,e.extend)(a().prototype,"onsubmit",(function(){this.usePaginationMode&&s().discussions&&s().discussions.refresh()}))}),-2)})(),module.exports=n})();
//# sourceMappingURL=forum.js.map