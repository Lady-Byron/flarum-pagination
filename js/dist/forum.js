(()=>{var t={n:s=>{var i=s&&s.__esModule?()=>s.default:()=>s;return t.d(i,{a:i}),i},d:(s,i)=>{for(var n in i)t.o(i,n)&&!t.o(s,n)&&Object.defineProperty(s,n,{enumerable:!0,get:i[n]})},o:(t,s)=>Object.prototype.hasOwnProperty.call(t,s),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},s={};(()=>{"use strict";t.r(s);const i=flarum.core.compat["common/app"];var n=t.n(i);const o=flarum.core.compat["common/extend"],e=flarum.core.compat["forum/components/DiscussionComposer"];var a=t.n(e);const r=flarum.core.compat["forum/utils/DiscussionControls"];var u=t.n(r);const c=flarum.core.compat["forum/app"];var l=t.n(c);const p=flarum.core.compat["forum/components/SettingsPage"];var g=t.n(p);const h=flarum.core.compat["common/components/FieldSet"];var f=t.n(h);const d=flarum.core.compat["common/utils/ItemList"];var v=t.n(d);const P=flarum.core.compat["common/components/Switch"];var b=t.n(P);const y=flarum.core.compat["common/utils/Stream"];var D=t.n(y);function L(){return L=Object.assign?Object.assign.bind():function(t){for(var s=1;s<arguments.length;s++){var i=arguments[s];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t},L.apply(this,arguments)}const C=flarum.core.compat["forum/states/DiscussionListState"];var k=t.n(C);const O=flarum.core.compat["forum/components/DiscussionList"];var N=t.n(O);const x=flarum.core.compat["forum/components/DiscussionListItem"];var I=t.n(x);const M=flarum.core.compat["common/components/Placeholder"];var R=t.n(M);const B=flarum.core.compat["common/components/LoadingIndicator"];var w=t.n(B);const S=flarum.core.compat["common/utils/classList"];var T=t.n(S);function _(t,s){return _=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,s){return t.__proto__=s,t},_(t,s)}const j=flarum.core.compat["common/Component"];var J=t.n(j);const q=flarum.core.compat["common/components/Button"];var F=t.n(q),A=function(t){var s,i;function n(){for(var s,i=arguments.length,n=new Array(i),o=0;o<i;o++)n[o]=arguments[o];return(s=t.call.apply(t,[this].concat(n))||this).attrs=void 0,s}i=t,(s=n).prototype=Object.create(i.prototype),s.prototype.constructor=s,_(s,i);var o=n.prototype;return o.view=function(t){var s=this.attrs.state;return m("div",{className:"Pagination"},m("ul",{class:"IndexPage-toolbar-view"},m("li",null,this.buttonFirst()),m("li",null,this.buttonBack()),s.ctrl.pageList().map((function(t){return m("li",null,m(F(),{title:t,className:s.page().number==t?"Button Button--primary Button--active":"Button",onclick:function(){s.ctrl.toPage(t)}},t))})),m("li",null,this.buttonNext()),m("li",null,this.buttonLast()),m("li",null,this.inputJump()),m("li",null,this.buttonJump())))},o.buttonFirst=function(){var t=this.attrs.state;return F().component({title:"First",icon:"fa fa-angle-double-left",className:"Button Button--icon",onclick:function(){t.ctrl.toPage(1)},disabled:1==t.page().number})},o.buttonBack=function(){var t=this.attrs.state;return F().component({title:"Back",icon:"fa fa-angle-left",className:"Button Button--icon",onclick:function(){var s=t.page().number;t.ctrl.toPage(parseInt(s)-1)},disabled:1==t.page().number})},o.buttonNext=function(){var t=this.attrs.state;return F().component({title:"Next",icon:"fa fa-angle-right",className:"Button Button--icon",onclick:function(){var s=t.page().number;t.ctrl.toPage(parseInt(s)+1)},disabled:t.page().number==t.totalPages()})},o.buttonLast=function(){var t=this.attrs.state;return F().component({title:"Last",icon:"fa fa-angle-double-right",className:"Button Button--icon",onclick:function(){var s=parseInt(t.totalPages());t.ctrl.toPage(s)},disabled:t.page().number==t.totalPages()})},o.JumpFunc=function(){var t,s=this.attrs.state,i=parseInt(null==(t=document.getElementById("pagination-inputJump"))?void 0:t.value);Number.isFinite(i)&&Number.isSafeInteger(i)&&i!=s.page().number&&1<=i&&i<=s.totalPages()&&s.ctrl.toPage(i)},o.inputJump=function(){var t=this,s=this.attrs.state;return m("input.FromControl",{id:"pagination-inputJump",placeholder:void 0===s.page().number?"":""+s.page().number,onkeydown:function(s){s.redraw=!1,13==s.keyCode&&(s.redraw=!0,t.JumpFunc())}})},o.buttonJump=function(){return F().component({title:"Jump",icon:"fa fa-paper-plane",className:"Button Button--icon",onclick:this.JumpFunc.bind(this)})},n}(J());n().initializers.add("foskym/flarum-pagination",(function(){(0,o.extend)(g().prototype,"oninit",(function(){var t=this.user.preferences();this.userCustom=D()(t["foskym-pagination.userCustom"]),this.userPaginationOnLoading=D()(t["foskym-pagination.userPaginationOnLoading"])})),(0,o.extend)(g().prototype,"settingsItems",(function(t){Boolean(l().forum.attribute("foskym-pagination.canUserPref"))&&t.add("pagination_settings",f().component({label:l().translator.trans("foskym-pagination.forum.user.settings.head"),className:"SettingsPage-pagination"},this.Pagination_UserPrefItems().toArray()))})),g().prototype.Pagination_UserPrefItems=function(){var t=this,s=new(v());return s.add("foskym-pagination.userCustom",b().component({state:this.user.preferences()["foskym-pagination.userCustom"],onchange:function(s){t.UserCustom_Loading=!0,t.user.savePreferences({"foskym-pagination.userCustom":s}).then((function(){t.UserCustom_Loading=!1,m.redraw()}))},loading:this.UserCustom_Loading},l().translator.trans("foskym-pagination.forum.user.settings.userCustom"))),this.user.preferences()["foskym-pagination.userCustom"]&&s.add("foskym-pagination.userPaginationOnLoading",b().component({state:this.user.preferences()["foskym-pagination.userPaginationOnLoading"],onchange:function(s){t.userPaginationOnLoading_Loading=!0,t.user.savePreferences({"foskym-pagination.userPaginationOnLoading":s}).then((function(){t.userPaginationOnLoading_Loading=!1,m.redraw()}))},loading:this.userPaginationOnLoading_Loading},l().translator.trans("foskym-pagination.forum.user.settings.userPaginationOnLoading"))),s},k().prototype.initOptions=function(){this.options={cacheDiscussions:n().forum.attribute("foskym-pagination.cacheDiscussions"),perPage:n().forum.attribute("foskym-pagination.perPage"),perLoadMore:n().forum.attribute("foskym-pagination.perLoadMore"),perIndexInit:n().forum.attribute("foskym-pagination.perIndexInit"),leftEdges:4,rightEdges:5},this.usePaginationMode=function(){if(null===l().session.user)return l().forum.attribute("foskym-pagination.paginationOnLoading");var t=l().session.user.preferences();return l().forum.attribute("foskym-pagination.canUserPref")&&t["foskym-pagination.userCustom"]?!!t["foskym-pagination.userPaginationOnLoading"]:l().forum.attribute("foskym-pagination.paginationOnLoading")}(),this.lastTotalDiscussionCount=0,this.lastTotalPages=0,this.lastDiscussions=[],this.lastLoadedPage={},this.lastRquestParams={},this.optionInited=!0},(0,o.override)(k().prototype,"refresh",(function(t,s){var i=this;return void 0===s&&(s=1),this.optionInited||this.initOptions(),this.usePaginationMode?(this.initialLoading=!0,this.loadingPrev=!1,this.loadingNext=!1,this.isRefreshing=!0,this.clear(),this.location={page:s},this.loadPage(s).then((function(t){i.pages=[],i.parseResults(i.location.page,t)})).finally((function(){i.initialLoading=!1,i.isRefreshing=!1}))):(this.pageSize=this.options.perLoadMore,t(s))})),(0,o.override)(k().prototype,"loadPage",(function(t,s){void 0===s&&(s=1);var i=this.requestParams();this.optionInited||this.initOptions(),this.lastRquestParams.include||(this.lastRquestParams=i);var o=n().preloadedApiDocument();if(o)return this.initialLoading=!1,this.isRefreshing=!1,this.totalDiscussionCount=D()(o.payload.jsonapi.totalResultsCount),this.lastTotalDiscussionCount=this.totalDiscussionCount(),Promise.resolve(o);if(!this.isRefreshing&&this.options.cacheDiscussions&&(JSON.stringify(i.include)!==JSON.stringify(this.lastRquestParams.include)||JSON.stringify(i.filter)!==JSON.stringify(this.lastRquestParams["filter.q"])||i.sort!==this.lastRquestParams.sort)&&this.lastLoadedPage[s]){var e=this.options.perPage*(s-1),a=this.options.perPage*s,r=this.lastDiscussions.slice(e,a);return r.payload={jsonapi:{totalResultsCount:this.totalDiscussionCount()}},this.initialLoading=!0,m.redraw(),new Promise((function(t){return setTimeout((function(){return t(r)}),50)}))}var u,c,l=Array.isArray(i.include)?i.include.join(","):i.include;this.usePaginationMode?(u=this.options.perPage*(s-1),c=this.options.perPage):c=0==(u=this.options.perIndexInit*Math.min(s-1,1)+this.options.perLoadMore*Math.max(s-2,0))?this.options.perIndexInit:this.options.perLoadMore;var p=L({},i,{page:L({},i.page,{offset:u,limit:c}),include:l});return n().store.find(this.type,p)})),(0,o.override)(k().prototype,"getAllItems",(function(t){return!1 in flarum.extensions?t():this.extraDiscussions.concat(this.getPages(!0).map((function(t){return t.items})).flat())})),(0,o.override)(k().prototype,"getPages",(function(t,s){var i=this;void 0===s&&(s=!1);var n=t();return!1 in flarum.extensions||s?n:[n.find((function(t){return t.number===i.location.page}))]})),(0,o.override)(k().prototype,"parseResults",(function(t,s,i){var n;if(!this.usePaginationMode)return t(s,i);var o=Number(s),e=(null==(n=i.payload)?void 0:n.links)||{},a={number:o,items:i,hasNext:!(null==e||!e.next),hasPrev:!(null==e||!e.prev)};if(this.hasPage=function(t){var s=this.getPages(!0);if(0==s.length)return!1;for(var i=0;i<s.length;i++)if(s[i].number==t)return!0;return!1},this.hasPage(o)||this.pages.push(a),this.pages=this.pages.sort((function(t,s){return t.number-s.number})),this.location={page:o},this.totalDiscussionCount=D()(i.payload.jsonapi.totalResultsCount),this.options.cacheDiscussions)if(this.lastTotalDiscussionCount!=this.totalDiscussionCount()&&0!=this.lastTotalDiscussionCount||0===this.lastTotalDiscussionCount||this.isRefreshing){this.lastTotalDiscussionCount=this.totalDiscussionCount();for(var r=0;r<this.lastTotalDiscussionCount;r++)this.lastDiscussions[r]={};this.lastLoadedPage={}}else{var u;this.lastLoadedPage[o]=a;var c=this.options.perPage*(o-1),l=this.options.perPage*o;(u=this.lastDiscussions).splice.apply(u,[c,l-c].concat(i))}this.getTotalPages=function(){return Math.ceil(this.totalDiscussionCount()/this.options.perPage)},this.page=D()(a),this.perPage=D()(this.options.perPage),this.totalPages=D()(this.getTotalPages()),this.ctrl={prevPage:function(){var t=this,s=this.page().number;if(!(--s<1)){this.page(s);var i=s;this.loadingPrev=!0,this.loadPage(i).then((function(s){t.parseResults(i,s),t.loadingPrev=!1}))}}.bind(this),nextPage:function(){var t=this,s=this.page().number;if(++s>this.totalPages())s=this.totalPages();else{this.page(s);var i=s;this.loadingNext=!0,this.loadPage(i).then((function(s){t.parseResults(i,s),t.loadingNext=!1}))}}.bind(this),toPage:function(t){var s=this;if(!(this.page().number==Number(t)||t<1||t>this.totalPages())){this.page(Number(t));var i=Number(t);this.initialLoading=!0,this.loadPage(i).then((function(t){s.parseResults(i,t),s.initialLoading=!1}))}}.bind(this),pageList:function(){for(var t=[],s=Math.max(parseInt(this.page().number)-this.options.leftEdges,1),i=Math.min(parseInt(this.page().number)+this.options.rightEdges,this.totalPages()),n=s;n<=i;n++)t.push(n);return t}.bind(this)},m.redraw()})),(0,o.override)(k().prototype,"addDiscussion",(function(t,s){if(!this.usePaginationMode)return t();var i=this.lastDiscussions.indexOf(s);-1!==i?(this.lastDiscussions.splice(i),this.lastDiscussions.unshift(s)):(this.lastDiscussions.unshift(s),this.lastTotalDiscussionCount++,this.totalDiscussionCount(this.lastTotalDiscussionCount)),m.redraw()})),(0,o.override)(k().prototype,"deleteDiscussion",(function(t,s){if(!this.usePaginationMode)return t();var i=this.lastDiscussions.indexOf(s);-1!==i&&(this.lastDiscussions.splice(i),this.lastTotalDiscussionCount--,this.totalDiscussionCount(this.lastTotalDiscussionCount)),m.redraw()})),(0,o.override)(k().prototype,"clear",(function(t){return this.usePaginationMode?(this.lastDiscussions=[],this.lastLoadedPage={},this.lastRquestParams={},this.lastTotalDiscussionCount=0,this.lastTotalPages=0,this.totalDiscussionCount=D()(0),t()):t()})),(0,o.override)(N().prototype,"view",(function(t){var s=this.attrs.state;if(!s.usePaginationMode)return t();var i=s.getParams(),o=s.isLoading();if(s.isEmpty()){var e=n().translator.trans("core.forum.discussion_list.empty_text");return m("div",{className:"DiscussionList"},m(R(),{text:e}))}if(o)return m("div",{className:T()("DiscussionList",{"DiscussionList--searchResults":s.isSearchResults()})},m("ul",{role:"feed","aria-busy":o,className:"DiscussionList-discussions"}),m("div",{className:"DiscussionList-loadMore"},m(w(),null)));for(var a=s.getPages(),r=[],u=0;u<a.length;u++){var c=a[u];if(c.number==s.location.page){r=c.items;break}}var l=n().forum.attribute("foskym-pagination.paginationPosition"),p=s.options.perPage,g=s.page,h=m("ul",{role:"feed","aria-busy":o,className:"DiscussionList-discussions"},r.map((function(t,s){return m("li",{key:t.id(),"data-id":t.id(),role:"article","aria-setsize":"-1","aria-posinset":g*p+s},m(I(),{discussion:t,params:i}))})));if("walsgit-discussion-cards"in flarum.extensions){var f=t();f.children.length>=2&&(f.children=f.children.slice(0,1)),h=f}return m("div",{className:T()("DiscussionList",{"DiscussionList--searchResults":s.isSearchResults()})},"above"==l||"both"==l?A.component({state:s}):"",h,"under"==l||"both"==l?A.component({state:s}):"")})),(0,o.extend)(u(),"deleteAction",(function(){if(this.usePaginationMode&&n().discussions){var t=n().discussions.location.page;n().discussions.refresh(t)}})),(0,o.extend)(a().prototype,"onsubmit",(function(){this.usePaginationMode&&n().discussions&&n().discussions.refresh()}))}),-2)})(),module.exports=s})();
//# sourceMappingURL=forum.js.map